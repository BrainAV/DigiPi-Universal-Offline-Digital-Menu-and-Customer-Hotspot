<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiPi - Universal Digital Menu</title>
    <link rel="stylesheet" href="public/assets/css/style.css">
    <style>
        /* Local Controls Overlay */
        #local-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        #local-controls.visible {
            display: block;
        }
        #local-controls h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }
        .control-group {
            margin-bottom: 10px;
        }
        button.fs-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        #settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        #settings-btn:hover {
            background: white;
        }
        #settings-btn.hidden {
            display: none;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DigiPi Menu</h1>
        <div id="menu-content">
            <table class="product-table" id="productTable">
                <thead>
                    <tr id="tableHeader">
                        <!-- Headers generated by JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
            <div id="loadingMessage" class="loading">Loading Menu Data...</div>
            <div id="errorMessage" class="error hidden"></div>
        </div>
    </div>

    <!-- Gear Button -->
    <button id="settings-btn" class="hidden" onclick="toggleControls()">⚙️</button>

    <!-- Local Controls Overlay -->
    <div id="local-controls" class="visible">
        <button class="close-btn" onclick="toggleControls()">&times;</button>
        <h3>Menu Controls</h3>
        <div class="control-group">
            <label for="csvInput" style="display:block; margin-bottom:5px; font-size:0.8rem;">Load CSV File:</label>
            <input type="file" id="csvInput" accept=".csv" style="width: 100%;">
        </div>
        <button class="fs-btn" onclick="toggleFullScreen()">Toggle Fullscreen</button>
        <p style="margin-top:10px; font-size:0.75rem; color:#666;">
            Tip: Load <code>public/assets/uploads/sample...</code> to test.
        </p>
    </div>

    <script>
        const sampleCsvPath = 'public/assets/uploads/sample_products_crystal_shop.csv';

        // 1. Attempt to auto-load the sample CSV (Works on Web Server / GitHub Pages)
        async function loadMenu() {
            try {
                const response = await fetch(sampleCsvPath);
                if (!response.ok) throw new Error("Network response was not ok");
                const text = await response.text();
                parseAndDisplay(text);
            } catch (error) {
                console.log("Auto-load failed (likely local file security):", error);
                document.getElementById('loadingMessage').classList.add('hidden');
                document.getElementById('errorMessage').innerHTML = 
                    "<strong>Local Mode Detected:</strong><br>Browser security prevented auto-loading the sample file.<br><br>Please manually select the sample CSV file using the box in the bottom right corner.";
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        }

        // 2. Parse CSV and Render Table
        function parseAndDisplay(csvText) {
            // Simple CSV parser (handles basic commas, assumes no commas in quotes for Level 1)
            const rows = csvText.split('\n').map(row => row.split(','));
            const headers = rows[0];
            // Filter out empty rows or rows with mismatching column counts
            const data = rows.slice(1).filter(row => row.length === headers.length && row[0].trim() !== '');

            // Render Headers
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.trim();
                headerRow.appendChild(th);
            });

            // Render Body
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell.trim();
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // 3. Handle Manual File Upload (Fallback for Local "Double-Click" usage)
        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                parseAndDisplay(e.target.result);
            };
            reader.readAsText(file);
        });

        // 4. Fullscreen Toggle
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // 5. Toggle Controls Overlay
        function toggleControls() {
            const controls = document.getElementById('local-controls');
            const btn = document.getElementById('settings-btn');
            
            if (controls.classList.contains('visible')) {
                controls.classList.remove('visible');
                btn.classList.remove('hidden');
            } else {
                controls.classList.add('visible');
                btn.classList.add('hidden');
            }
        }

        // Initialize
        loadMenu();
    </script>
</body>
</html>